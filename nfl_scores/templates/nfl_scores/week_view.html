<!DOCTYPE html>
<html>
<head>
	<title>NFL Week {{week}}</title>
	<meta name="viewport" content="width=device-width, initial-scale=1.0001, minimum-scale=1.0001, maximum-scale=1.0001, user-scalable=no"/>
	{% load static %}
	<link rel="stylesheet" type="text/css" href="{% static 'nfl_scores/bootstrap.min.css' %}">
	<link rel="stylesheet" type="text/css" href="{% static 'nfl_scores/mdbootstrap.compiled.min.css' %}">
	<link rel="stylesheet" type="text/css" href="{% static 'nfl_scores/main.css' %}">
	<link rel="stylesheet" type="text/css" href="{% static 'nfl_scores/palette.css' %}">
	<link rel="stylesheet" href="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8/themes/base/jquery-ui.css" type="text/css" />
</head>
<body class="light-primary-color">
	<nav class="navbar text-center">
		<h1 class="text-primary-color">NFL Game Scores</h1>
		<a href="/standings"><h4 class="text-center text-primary-color">Standings</h4></a>
	</nav>
	<div class="week-nav text-center container">
		{% if week == 1 %}
			<div class="previous-week btn blank-button">
				<h4><span>&lt;</span>{{week|add:"-1"}}</h4>
			</div>
		{% else %}
			<a href={% url 'week' week|add:"-1" %}>
				<div class="previous-week btn dark-primary-color">
					<h4><span>&lt;</span>{{week|add:"-1"}}</h4>
				</div>
			</a>
		{% endif %}
		<div class="current-week btn-group">
			<button class="btn btn-primary dropdown-toggle accent-color" type="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
				<h4>Week {{week}}</h4>
		  	</button>
		  	<div class="dropdown-menu">
		  		<!-- Hack to show all 17 weeks, found from
		  		http://stackoverflow.com/questions/1107737/numeric-for-loop-in-django-templates-->
	  			{% for i in "aaaaaaaaaaaaaaaaa" %}
	  				<a class="dropdown-item" href={% url 'week' forloop.counter %}>{{forloop.counter}}</a>
				{% endfor %}
		  	</div>
		</div>
		{% if week == 17 %}
			<div class="next-week btn blank-button">
				<h4>{{week|add:"1"}}<span>&gt;</span></h4>
			</div>
		{% else %}
			<a href={% url 'week' week|add:"1" %}>
				<div class="next-week btn dark-primary-color">
					<h4>{{week|add:"1"}}<span>&gt;</span></h4>
				</div>
			</a>
		{% endif %}
	</div>
	<form id="search-team" class="team-search">
		<input id="search-query" type="text" list="json-datalist" name="t" placeholder="Search for a team">
		<datalist id="json-datalist"></datalist>
		<input id="submit-team" type="submit" value="Search" disabled="disabled">
		{% if team != 'NONE' %}
			<a href={% url 'week' week %}>Reset</a>
		{% endif %}

	</form>
	<div class="games container-fluid">
		<div class="row text-center">
			{% if future_games|length == 0 %}
				{% for game in games %}
				<div class="col-lg-3 col-md-5 col-sm-5 col-xs-10 game dark-primary-color">
					<div class="text-primary-color">
						<div class="team-game-data">
							{% if game.away_score >= game.home_score %}
								<h5 class="text-left winner away_team">{{game.away_team.long_name}}</h5>
								<h5 class="text-left home_team">{{game.home_team.long_name}}</h5>
							{% else %}
								<h5 class="text-left away_team">{{game.away_team.long_name}}</h5>
								<h5 class="text-left winner home_team">{{game.home_team.long_name}}</h5>
							{% endif %}
						</div>
						<table class="quarter-points">
							<tr align="right" class="top-table-row">
								<td class="quarter-total away_q1"></td>
								<td class="quarter-total away_q2"></td>
								<td class="quarter-total away_q3"></td>
								<td class="quarter-total away_q4"></td>
								{% if game.away_score >= game.home_score %}
									<td class="winner">{{game.away_score}}</td>
								{% else %}
									<td>{{game.away_score}}</td>
								{% endif %}
							</tr>
							<tr align="right">
								<td class="quarter-total home_q1"></td>
								<td class="quarter-total home_q2"></td>
								<td class="quarter-total home_q3"></td>
								<td class="quarter-total home_q4"></td>
								{% if game.home_score >= game.away_score %}
									<td class="winner">{{game.home_score}}</td>
								{% else %}
									<td>{{game.home_score}}</td>
								{% endif %}
							</tr>
						</table>
					</div>
					<!-- This checkbox is a hack to know whether or not to
					display the quarter-by-quarter scoring table -->
					<input type="checkbox" name="hidden-checkbox">
				</div>
				{% endfor %}
			{% else %}
				{% for game in future_games %}
					<div class="col-md-3 col-sm-5 col-xs-10 future-game dark-primary-color" disabled="true">
						<div class="text-center text-primary-color">
							<h5>{{game.home.name}}</h5>
							<h5>{{game.away.name}}</h5>
						</div>
					</div>
				{% endfor %}
			{% endif %}
		</div>
		{% if games|length == 0 and future_games|length == 0 %}
			<h4 class="text-center">The {{team}} are on bye this week.</h4>
		{% endif %}
	</div>
</body>
	<script src="https://code.jquery.com/jquery-3.1.1.min.js" integrity="sha256-hVVnYaiADRTO2PzUGmuLJr8BLUSjGIZsDYGmIJLv2b8=" crossorigin="anonymous"></script>
	<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
  	<script>
		$("#search-query").val("");
  		$(".game").click( function() {
			gameElement = $(this)
  			// if the checkbox is unchecked then show the quarter-points
			if (!gameElement.find('input').prop("checked")) {
				gameElement.find('input').prop('checked', true);
				away_team = gameElement.find('.away_team').text();
				home_team = gameElement.find('.home_team').text();
				week = $(".current-week").find("h4").text().split(" ")[1]
				$.ajax({
					url: '/get_quarter_points',
					type: 'get',
					dataType: 'json',
					data: {'away_team': away_team, 'home_team': home_team, 'week': week},
					success: function(data) {
						data = data.points_per_quarter
						gameElement.find('.away_q1').text(data.away_q1)
						gameElement.find('.away_q2').text(data.away_q2)
						gameElement.find('.away_q3').text(data.away_q3)
						gameElement.find('.away_q4').text(data.away_q4)
						gameElement.find('.home_q1').text(data.home_q1)
						gameElement.find('.home_q2').text(data.home_q2)
						gameElement.find('.home_q3').text(data.home_q3)
						gameElement.find('.home_q4').text(data.home_q4)
					},
					failure: function(data) {
						alert('Error, try again');
					}
				});
  			} 
			else {
				gameElement.find('input').prop('checked', false);
				gameElement.find('.away_q1').text("")
				gameElement.find('.away_q2').text("")
				gameElement.find('.away_q3').text("")
				gameElement.find('.away_q4').text("")
				gameElement.find('.home_q1').text("")
				gameElement.find('.home_q2').text("")
				gameElement.find('.home_q3').text("")
				gameElement.find('.home_q4').text("")
  			}
  		});

		var dataList = document.getElementById('json-datalist');
		var teamSet = new Set();

		// The following polyfill code came from https://github.com/thgreasi/datalist-polyfill
		var browserSupportsDatalist = !!('list' in document.createElement('input')) && !!(document.createElement('datalist') && window.HTMLDataListElement);

		// autocomplete code found from https://jqueryui.com/autocomplete/
		if (!browserSupportsDatalist) {
			teamList = []
			$("#search-query").attr('autocomplete','on');
			$.ajax({
				url: '/get_teams',
				type: 'get',
				dataType: 'json',
				data: {'searchString': ""},
				success: function(data) {
					teams = data.teams;
					for (var i = 0; i < teams.length; i++) {
						teamList.push(teams[i].name);
					}
					$("#search-query").autocomplete({ source: teamList });
				},
				failure: function(data) {
					alert('Error, try again');
				}
			});
		}
		$("#search-team").on('input',function(e){
			if (browserSupportsDatalist) {
				var searchString = $("#search-query").val();

				// Referenced the following link to create the ajax call:
				//    https://simpleisbetterthancomplex.com/tutorial/2016/08/29/how-to-work-with-ajax-request-with-django.html
				// Referenced the following link to create the dropdown form:
				//    http://blog.teamtreehouse.com/creating-autocomplete-dropdowns-datalist-element
				$.ajax({
					url: '/get_teams',
					type: 'get',
					dataType: 'json',
					data: {'searchString': searchString},
					success: function(data) {
						teams = data.teams;
						for (var i = 0; i < teams.length; i++) {
							teamName = teams[i].name;
							if (searchString == teamName) {
								$("#submit-team").removeAttr('disabled')
							}
							else {
								$("#submit-team").attr('disabled', 'disabled');
							}
							if (!teamSet.has(teamName)) {
								teamSet.add(teamName);
								var option = document.createElement('option');
								option.value = teamName;
								dataList.appendChild(option);
							}
							else {
								continue;
							}
						}
					},
					failure: function(data) {
						alert('Error, try again');
					}
				});
			}
		});
  	</script>
</html>